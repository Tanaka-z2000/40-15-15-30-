import React, { useState, useMemo, useRef } from 'react';

const App = () => {
  const [values, setValues] = useState({
    v662: '',
    v631L: '',
    v670L: '',
    cash: ''
  });
  const [aiAnalysis, setAiAnalysis] = useState('');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const audioRef = useRef(null);

  const TARGETS = {
    t662: 0.40,
    t631L: 0.15,
    t670L: 0.15,
    cash: 0.30
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setValues(prev => ({ ...prev, [name]: value }));
  };

  const report = useMemo(() => {
    const v662 = parseFloat(values.v662) || 0;
    const v631L = parseFloat(values.v631L) || 0;
    const v670L = parseFloat(values.v670L) || 0;
    const cash = parseFloat(values.cash) || 0;
    
    const totalWealth = v662 + v631L + v670L + cash;
    if (totalWealth <= 0) return null;

    const currentRatios = {
      '00662': { ratio: v662 / totalWealth, amount: v662 },
      '00631L': { ratio: v631L / totalWealth, amount: v631L },
      '00670L': { ratio: v670L / totalWealth, amount: v670L },
      'cash': { ratio: cash / totalWealth, amount: cash }
    };

    // 433 æ ¸å¿ƒè¦å‰‡ï¼š00662 åªè²·ä¸è³£
    const targetV662Base = totalWealth * TARGETS.t662;
    const finalV662 = Math.max(v662, targetV662Base); 
    
    // è³¸é¤˜è³‡é‡‘åˆ†é…çµ¦æµå‹•æ€§æ¨™çš„ (00631L, 00670L, Cash)
    const remainingWealth = totalWealth - finalV662;
    const liquidWeightTotal = TARGETS.t631L + TARGETS.t670L + TARGETS.cash; 
    
    const final631L = remainingWealth * (TARGETS.t631L / liquidWeightTotal);
    const final670L = remainingWealth * (TARGETS.t670L / liquidWeightTotal);
    const finalCash = remainingWealth * (TARGETS.cash / liquidWeightTotal);

    const post = {
      v662: { ratio: finalV662 / totalWealth, amount: finalV662, diff: finalV662 - v662 },
      v631L: { ratio: final631L / totalWealth, amount: final631L, diff: final631L - v631L },
      v670L: { ratio: final670L / totalWealth, amount: final670L, diff: final670L - v670L },
      cash: { ratio: finalCash / totalWealth, amount: finalCash, diff: finalCash - cash }
    };

    // å»ºè­°è·¯å¾‘æ’åºï¼šå…ˆè³£å¾Œè²·
    let actions = [];
    const sellActions = [];
    const buyActions = [];

    if (post.v631L.diff < -1) {
      sellActions.push(`å¾ 00631L è³£å‡º/è´–å› ${Math.abs(Math.round(post.v631L.diff)).toLocaleString()} å…ƒä¸¦è½‰å…¥æµå‹•è³‡é‡‘`);
    }
    if (post.v670L.diff < -1) {
      sellActions.push(`å¾ 00670L è³£å‡º/è´–å› ${Math.abs(Math.round(post.v670L.diff)).toLocaleString()} å…ƒä¸¦è½‰å…¥æµå‹•è³‡é‡‘`);
    }
    if (post.cash.diff < -1) {
      sellActions.push(`å¾ç¾é‡‘éƒ¨ä½æé ˜ ${Math.abs(Math.round(post.cash.diff)).toLocaleString()} å…ƒä¾›å†å¹³è¡¡èª¿åº¦`);
    }

    if (post.v662.diff > 1) {
      buyActions.push(`å°‡æµå‹•è³‡é‡‘æ’¥å‡º ${Math.round(post.v662.diff).toLocaleString()} å…ƒè²·å…¥ 00662`);
    }
    if (post.v631L.diff > 1) {
      buyActions.push(`æŠ•å…¥ ${Math.round(post.v631L.diff).toLocaleString()} å…ƒè‡³ 00631L`);
    }
    if (post.v670L.diff > 1) {
      buyActions.push(`æŠ•å…¥ ${Math.round(post.v670L.diff).toLocaleString()} å…ƒè‡³ 00670L`);
    }
    if (post.cash.diff > 1) {
      buyActions.push(`å°‡èª¿æ•´å¾Œçš„è³¸é¤˜è³‡é‡‘ ${Math.round(post.cash.diff).toLocaleString()} å…ƒå­˜å›ç¾é‡‘éƒ¨ä½`);
    }

    actions = [...sellActions, ...buyActions];

    return { totalWealth, currentRatios, actions, post };
  }, [values]);

  const pcmToWav = (pcmData, sampleRate) => {
    const buffer = new ArrayBuffer(44 + pcmData.length * 2);
    const view = new DataView(buffer);
    const writeString = (offset, string) => {
      for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
      }
    };
    writeString(0, 'RIFF');
    view.setUint32(4, 32 + pcmData.length * 2, true);
    writeString(8, 'WAVE');
    writeString(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeString(36, 'data');
    view.setUint32(40, pcmData.length * 2, true);
    for (let i = 0; i < pcmData.length; i++) {
      view.setInt16(44 + i * 2, pcmData[i], true);
    }
    return new Blob([buffer], { type: 'audio/wav' });
  };

  const speakAnalysis = async (text) => {
    if (!text) return;
    setIsSpeaking(true);
    const apiKey = "";
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `ç”¨å°ˆæ¥­ä¸”è¦ªåˆ‡çš„èªæ°£è®€å‡ºä»¥ä¸‹æŠ•è³‡å»ºè­°ï¼š${text}` }] }],
          generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
          }
        })
      });
      const result = await response.json();
      const audioData = result.candidates[0].content.parts[0].inlineData.data;
      const binaryString = atob(audioData);
      const pcmData = new Int16Array(binaryString.length / 2);
      for (let i = 0; i < pcmData.length; i++) {
        pcmData[i] = binaryString.charCodeAt(i * 2) | (binaryString.charCodeAt(i * 2 + 1) << 8);
      }
      const wavBlob = pcmToWav(pcmData, 24000);
      const url = URL.createObjectURL(wavBlob);
      if (audioRef.current) {
        audioRef.current.src = url;
        audioRef.current.play();
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsSpeaking(false);
    }
  };

  const runAiAnalysis = async () => {
    if (!report) return;
    setIsAnalyzing(true);
    setAiAnalysis('');
    const apiKey = ""; 
    const model = "gemini-2.5-flash-preview-09-2025";
    const systemPrompt = "ä½ æ˜¯ä¸€ä½é ‚å°–çš„ 433 é…ç½®å°ˆå®¶ã€‚é‡å°è³‡ç”¢ç‹€æ…‹æä¾›åˆ†æã€‚åŒ…å«ï¼š1. ç›®å‰åé›¢ç¨‹åº¦ã€‚2. å¸‚å ´é¢¨éšªã€‚3. æ“ä½œå»ºè­°ã€‚";
    const userQuery = `ç¸½è³‡ç”¢: ${report.totalWealth}ã€‚ç›®å‰ä½”æ¯”: 00662(${(report.currentRatios['00662'].ratio*100).toFixed(1)}%), 00631L(${(report.currentRatios['00631L'].ratio*100).toFixed(1)}%), 00670L(${(report.currentRatios['00670L'].ratio*100).toFixed(1)}%), ç¾é‡‘(${(report.currentRatios['cash'].ratio*100).toFixed(1)}%)ã€‚`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: userQuery }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] }
        })
      });
      const result = await response.json();
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
      setAiAnalysis(text || "åˆ†æå¤±æ•—");
    } catch (err) {
      setAiAnalysis("åˆ†ææš«æ™‚ç„¡æ³•ä½¿ç”¨ã€‚");
    } finally {
      setIsAnalyzing(false);
    }
  };

  return (
    <div className="p-4 sm:p-6 max-w-5xl mx-auto bg-gray-50 min-h-screen font-sans">
      <audio ref={audioRef} onEnded={() => setIsSpeaking(false)} />
      <div className="bg-white p-6 sm:p-8 rounded-3xl shadow-xl border border-gray-100">
        <h1 className="text-2xl font-black text-gray-800 mb-8 border-b pb-4 flex items-center justify-center gap-3">
          <span className="bg-blue-600 text-white p-1 rounded-lg">433</span> 
          æ™ºæ…§å†å¹³è¡¡åŠ©æ‰‹ 
        </h1>
        
        {/* è¼¸å…¥å€ */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          {[
            { id: 'v662', label: '00662 å¸‚å€¼', icon: 'ğŸ“ˆ' },
            { id: 'cash', label: 'ç¾é‡‘å„²å‚™', icon: 'ğŸ’°' },
            { id: 'v631L', label: '00631L å¸‚å€¼', icon: 'âš¡' },
            { id: 'v670L', label: '00670L å¸‚å€¼', icon: 'ğŸ¦…' }
          ].map(item => (
            <div key={item.id} className="relative group">
              <label className="block text-xs font-black text-gray-500 mb-2 ml-1 uppercase tracking-wider">{item.icon} {item.label}</label>
              <input 
                type="number" 
                name={item.id} 
                value={values[item.id]} 
                onChange={handleInputChange} 
                placeholder="0" 
                className="w-full p-4 bg-gray-50 border-2 border-transparent rounded-2xl focus:border-blue-500 focus:bg-white outline-none transition-all font-bold text-gray-800"
              />
            </div>
          ))}
        </div>

        {report ? (
          <div className="space-y-10">
            {/* æ ¸å¿ƒæ•¸æ“šèˆ‡ AI æŒ‰éˆ• */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div className="lg:col-span-1 bg-gray-900 p-6 rounded-3xl text-white shadow-2xl">
                <div className="text-xs font-bold text-blue-400 mb-1 uppercase tracking-widest">Net Worth</div>
                <div className="text-4xl font-black tabular-nums">${Math.round(report.totalWealth).toLocaleString()}</div>
              </div>
              <div className="lg:col-span-2 flex gap-3">
                <button onClick={runAiAnalysis} disabled={isAnalyzing} className="flex-1 bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 rounded-3xl font-black text-lg shadow-sm disabled:opacity-50 transition-all active:scale-95">
                  {isAnalyzing ? "AI æ€è€ƒä¸­..." : "âœ¨ åŸ·è¡Œæ™ºæ…§åˆ†æ"}
                </button>
                {aiAnalysis && (
                  <button onClick={() => speakAnalysis(aiAnalysis)} disabled={isSpeaking} className="aspect-square bg-blue-600 text-white rounded-3xl flex items-center justify-center hover:bg-blue-700 transition-all active:scale-90 shadow-lg disabled:bg-gray-300">
                    {isSpeaking ? "ğŸ”Š" : "âœ¨ ğŸ”Š"}
                  </button>
                )}
              </div>
            </div>

            {/* AI åˆ†æ */}
            {aiAnalysis && (
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 p-6 rounded-3xl">
                <h3 className="text-blue-900 font-black mb-4 flex items-center gap-2">âœ¨ Gemini ç­–ç•¥æ´å¯Ÿ</h3>
                <div className="text-sm text-blue-800 leading-relaxed whitespace-pre-wrap font-medium">{aiAnalysis}</div>
              </div>
            )}

            {/* ç›®å‰é…ç½®èˆ‡åé›¢åº¦ (å«å…·é«”å¸‚å€¼) */}
            <div>
              <h2 className="text-lg font-black text-gray-800 mb-5 flex items-center gap-3"><span className="w-2 h-8 bg-blue-600 rounded-full"></span>ç›®å‰é…ç½®èˆ‡åé›¢åº¦</h2>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {Object.entries(report.currentRatios).map(([name, data]) => {
                  const target = name === '00662' ? 0.4 : name === 'cash' ? 0.3 : 0.15;
                  const diff = (data.ratio - target) * 100;
                  return (
                    <div key={name} className="flex flex-col p-5 bg-white border-2 border-gray-100 rounded-[2rem] shadow-sm hover:shadow-md transition-shadow">
                      <div className="flex justify-between items-start mb-2">
                        <span className="text-[10px] font-black text-gray-400 uppercase">{name}</span>
                        <span className="text-xl font-black text-gray-900">{(data.ratio * 100).toFixed(1)}%</span>
                      </div>
                      <div className="bg-gray-100 rounded-xl p-3 mb-3 border-l-4 border-gray-300">
                        <div className="text-[9px] font-black text-gray-500 mb-0.5">ç›®å‰å¸‚å€¼</div>
                        <div className="font-mono text-xs font-bold text-gray-700 break-all">${Math.round(data.amount).toLocaleString()}</div>
                      </div>
                      <div className={`text-[10px] font-bold px-2 py-0.5 rounded-full inline-block w-fit ${Math.abs(diff) < 2 ? 'bg-green-100 text-green-700' : 'bg-red-50 text-red-600'}`}>
                        {Math.abs(diff) < 2 ? 'å®Œç¾å¹³è¡¡' : `${diff > 0 ? 'è¶…æ¨™' : 'ä¸è¶³'} ${Math.abs(diff).toFixed(1)}%`}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* å»ºè­°è·¯å¾‘ (å…ˆè³£å¾Œè²·) */}
            <div>
              <h2 className="text-lg font-black text-gray-800 mb-5 flex items-center gap-3"><span className="w-2 h-8 bg-green-500 rounded-full"></span>æœ€ä½³å†å¹³è¡¡å»ºè­°è·¯å¾‘ (å…ˆè³£å¾Œè²·)</h2>
              <div className="bg-gray-900 text-green-400 p-8 rounded-[2rem] font-mono text-sm leading-relaxed border-l-[12px] border-green-500 shadow-2xl">
                {report.actions.length > 0 ? report.actions.map((act, i) => (
                  <div key={i} className="mb-4 whitespace-pre-wrap break-words border-b border-gray-800 pb-4 last:border-0 last:mb-0 flex items-start gap-4">
                    <span className="bg-gray-800 text-green-400 px-3 py-1 rounded-lg font-bold text-[10px] whitespace-nowrap">STEP {i + 1}</span>
                    <span className="text-gray-100 font-bold">{act}</span>
                  </div>
                )) : <div className="text-center py-6 text-gray-500 italic">é…ç½®è™•æ–¼æœ€ä½³ç‹€æ…‹ã€‚</div>}
              </div>
            </div>

            {/* é æœŸç›®æ¨™ */}
            <div>
              <h2 className="text-lg font-black text-gray-800 mb-6">âœ¨ é è¨ˆå†å¹³è¡¡å¾Œç›®æ¨™å¸‚å€¼</h2>
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                {Object.entries(report.post).map(([key, data]) => {
                  const label = key === 'v662' ? '00662' : key === 'v631L' ? '00631L' : key === 'v670L' ? '00670L' : 'Cash';
                  return (
                    <div key={key} className="flex flex-col group">
                      <div className="flex justify-between items-end mb-3 px-2">
                        <span className="text-gray-400 font-black text-[10px] uppercase">{label}</span>
                        <span className="font-black text-2xl text-blue-600">{(data.ratio * 100).toFixed(1)}%</span>
                      </div>
                      <div className="bg-white border-2 border-gray-100 rounded-[1.5rem] p-5 shadow-sm min-h-[140px] flex flex-col justify-between">
                        <div>
                          <div className="text-[10px] font-black text-gray-400 mb-1">ç›®æ¨™å¸‚å€¼</div>
                          <div className="font-mono text-xl font-black text-gray-900 break-all leading-tight">${Math.round(data.amount).toLocaleString()}</div>
                        </div>
                        <div className={`mt-2 p-2 rounded-xl text-center font-bold text-xs ${data.diff >= 0 ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}`}>
                           {data.diff >= 0 ? `éœ€å¢åŠ  $${Math.abs(Math.round(data.diff)).toLocaleString()}` : `éœ€èª¿æ•´ $${Math.abs(Math.round(data.diff)).toLocaleString()}`}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        ) : (
          <div className="text-center py-32 bg-gray-50/50 border-4 border-dashed border-gray-100 rounded-[3rem] mt-10">
            <div className="text-7xl mb-6">ğŸ“ˆ</div>
            <p className="font-black text-gray-400 text-xl">è«‹è¼¸å…¥å„æ¨™çš„å¸‚å€¼ä»¥é–‹å§‹åˆ†æ</p>
          </div>
        )}
      </div>
      <footer className="text-center py-10 text-gray-300 font-bold text-[10px] uppercase tracking-[0.2em]">433 System Intelligence</footer>
    </div>
  );
};

export default App;
